trigger:
- azure_pipelines

jobs:
- job:
  displayName: WindowsAgent
  pool: 'Default'

  strategy:
    matrix:
      64-bit Release:
        BuildType: RelWithDebInfo
        CMakeArgs: '"Visual Studio 15 2017 Win64"'
        BuildFolder: '$(Build.BinariesDirectory)\build'
        InstallFolder: '$(Build.BinariesDirectory)\install'
        Variant: '--build-relwithdebug'

  steps:
     - task: UsePythonVersion@0
       inputs:
        versionSpec: '2.x' 
        addToPath: true 
        architecture: 'x64' # Options: x86, x64 (this argument applies only on Windows agents)
       displayName: Use python 2.7!

     - script: |
        SET PATH=C:\Program Files (x86)\Microsoft Visual Studio\2017\Professional\VC\Tools\MSVC\14.16.27023\bin\HostX64\x64;C:\Program Files\CMake\bin\cmake.exe;%PATH%
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Professional\VC\Auxiliary\Build\vcvars64.bat"

     - script: python build.py 
               --pxrusd-location "C:\Users\hamed\Desktop\USD2002" 
               --maya-location "C:\Program Files\Autodesk\Maya2021" 
               --devkit-location "C:\Users\hamed\Desktop\PR112_DEVKIT\devkitBase"  
               --stages=configure,build,install 
               --generator=Ninja 
               --build-args=-DCMAKE_MAKE_PROGRAM=C:/ninja.exe 
               $(InstallFolder)

       displayName: 'Run build script!'
     
     # - task: DeleteFiles@1
     #   inputs:
     #     SourceFolder: '$(Build.BinariesDirectory)\install'
     #     Contents: |
     #       build
     #       share
     #       src
     #       cmake

     - task: ArchiveFiles@2
       inputs:
         rootFolderOrFile: '$(Build.BinariesDirectory)\install'
         includeRootFolder: false
         archiveType: 'zip'
         archiveFile: '$(Build.ArtifactStagingDirectory)/MayaUSD-0.1.0-Windows.zip'
         replaceExistingArchive: true
         
     - task: PublishBuildArtifacts@1
       inputs:
         PathtoPublish: '$(Build.ArtifactStagingDirectory)'
         ArtifactName: 'MayaUSD-0.1.0'
         publishLocation: 'Container'
         parallel: true
